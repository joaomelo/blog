--- 
tags: ['draft']
title: Building an Event Bus With Vanilla JavaScript
abstract: The Event Bus is a common pattern to provide central access to general events inside an app or between services. The post describes how to fast implement a working version with just vanilla JavaScript.
--- 

The Event Bus is a typical pattern in programming to decouple pieces of an app. It is a central interface to publish and listen to events like logging messages or alerting the user. Some module is able to subscribe to an event without any knowledge of the publisher component and vice-versa. 

This kind of technic is commonly seen in large scales infrastructures to provide integration between different services. But even in small codebases, the Event Bus could be a practical way to provide general services to the whole app. A module may import the central Bus to signal the start of some task and the UI module will automatic triggers a loading screen.

## Building an Event Bus

A viable version could be achieved very fast. Let's start that by implementing a `subscribe` function that feeds a `Map` of subscriptions. A subscription will be an array of observers functions to be called when some specific event type (also know as topic) is published.

``` js
// event-bus.js
const subscriptions = new Map();

function subscribe (topic, observer) {
  if (!subscriptions.has(topic)) {
    subscriptions.set(topic, []);
  }
  const subscription = subscriptions.get(topic);
  subscription.push(observer);
}

export { subscribe }
```

Then, we implement the `publish` function to invoke all the observer functions associated to a topic passing some arbitrary parameter. 

``` js
// event-bus.js

// ... subscribe code

function publish (topic, payload) {
  if (!subscriptions.has(topic)) return;
  const subscription = subscriptions.get(topic);
  subscription.forEach(observer => observer(payload));
}

export { subscribe, publish }
```

Other modules became able to import subscribe and publish to take advantage of our Event Bus. 

``` js
// subscriber.js
import { subscribe } from './event-bus';
subscribe('SOME_EVENT', payload => console.log(payload));
subscribe('SOME_EVENT', payload => console.log(payload));

// publisher.js
import { publish } from './event-bus';
publish('SOME_EVENT', 'hi');
```

## Improvements and Tradeoffs

That's it, we have an app with a working Event Bus. That might be improved to offer additional features as needed. For example, with two lines of code `subscribe` could return an unsubscribe function. When called, unsubscribe removes the corresponding observer from that subscription.

``` js
function subscribe (topic, observer) {
  if (!subscriptions.has(topic)) {
    subscriptions.set(topic, []);
  }
  const subscription = subscriptions.get(topic);
  subscription.push(observer);

  const unsubscribe = () => subscription.splice(subscription.indexOf(observer), 1);
  return unsubscribe;  
}
```

Now someone is able to do something like this:

``` js
// subscriber.js
import { subscribe } from './event-bus';
const unsub = subscribe('SOME_EVENT', payload => console.log(payload));
unsub(); 

// publisher.js
import { publish } from './event-bus';
publish('SOME_EVENT', 'hi'); // nothing will be printed 
```

Others improvements are available. There was no code to deal with exceptions in observers or maybe we could add the ability to an observer be called immediately after subscribing with the last published payload.

But probably is best to consider some proven library if you want something sophisticated. For example, I made for myself a [package](https://github.com/joaomelo/bus) with that ability to immediately call after subscription. But the golden standard for event utilities is [Rxjs](https://rxjs-dev.firebaseapp.com/). The library `Subject` class is a perfect candidate to build Event Buses.

Nevertheless, is relevant to note that the solution is not free of tradeoffs. Because of its potential to be used everywhere, a failing one would be disastrous for an app. Other issue is that as complexity and signal rate rises, the Event Bus could become a performance challenge.

That's it. I leave you with my best regards.

