<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <link href="https://unpkg.com/tailwindcss@^1.0/dist/tailwind.min.css" rel="stylesheet">

    <style>
        

        /**
        * okaidia theme for JavaScript, CSS and HTML
        * Loosely based on Monokai textmate theme by http://www.monokai.nl/
        * @author ocodia
        */    

        code[class*="language-"],
        pre[class*="language-"] {
          color: #f8f8f2;
          background: none;
          text-shadow: 0 1px rgba(0, 0, 0, 0.3);
          font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
          font-size: 1em;
          text-align: left;
          white-space: pre;
          word-spacing: normal;
          word-break: normal;
          word-wrap: normal;
          line-height: 1.5;

          -moz-tab-size: 4;
          -o-tab-size: 4;
          tab-size: 4;

          -webkit-hyphens: none;
          -moz-hyphens: none;
          -ms-hyphens: none;
          hyphens: none;
        }

        /* Code blocks */
        pre[class*="language-"] {
          padding: 1em;
          margin: .75em 1rem 0;
          overflow: auto;
          border-radius: 0.3em;
        }

        :not(pre) > code[class*="language-"],
        pre[class*="language-"] {
          background: #272822;
        }

        /* Inline code */
        :not(pre) > code[class*="language-"] {
          padding: .1em;
          border-radius: .3em;
          white-space: normal;
        }

        .token.comment,
        .token.prolog,
        .token.doctype,
        .token.cdata {
          color: slategray;
        }

        .token.punctuation {
          color: #f8f8f2;
        }

        .token.namespace {
          opacity: .7;
        }

        .token.property,
        .token.tag,
        .token.constant,
        .token.symbol,
        .token.deleted {
          color: #f92672;
        }

        .token.boolean,
        .token.number {
          color: #ae81ff;
        }

        .token.selector,
        .token.attr-name,
        .token.string,
        .token.char,
        .token.builtin,
        .token.inserted {
          color: #a6e22e;
        }

        .token.operator,
        .token.entity,
        .token.url,
        .language-css .token.string,
        .style .token.string,
        .token.variable {
          color: #f8f8f2;
        }

        .token.atrule,
        .token.attr-value,
        .token.function,
        .token.class-name {
          color: #e6db74;
        }

        .token.keyword {
          color: #66d9ef;
        }

        .token.regex,
        .token.important {
          color: #fd971f;
        }

        .token.important,
        .token.bold {
          font-weight: bold;
        }
        .token.italic {
          font-style: italic;
        }

        .token.entity {
          cursor: help;
        }
    </style>

    <title>blog.melo.plus</title>
  </head>
  <body class="bg-green-100 text-gray-700">
    

<div class="min-h-screen max-w-screen-sm mx-auto px-4 bg-white">
  <header class="text-right"><a href="/" target="_self" class="font-semibold text-gray-700 rounded-full hover:text-green-400">home</a></header>
  <main>
    

<article>
  
  <h1 class="text-center text-3xl font-semibold capitalize">How To Combine Firebase Authentication And Firestore To Save User Data</h1>

  <p class="text-xs text-center"><time datetime="2020-06-07T03:00:00.000Z">June 7, 2020</time></p>
  <div class="mt-4 text-justify">
  <p class="mt-3"><a href="https://firebase.google.com/" class="font-semibold text-gray-700 hover:text-green-400">Firebase</a> is a boost of agility to solo developers and small teams. One of its main conveniences is the authentication service. But after a few times building login UI with Firebase Authentication (Fireauth), I found myself repeating code to wrap or complement its features. One of such cases is the need to combine user data from Fireauth with another database.</p>
<p class="mt-3">Fireauth can hold some profile user data, but they are limited to a <a href="https://firebase.google.com/docs/auth/users#user_properties" class="font-semibold text-gray-700 hover:text-green-400">&quot;fixed set of basic properties&quot;</a>. If you want more, you need a database solution. Firestore is part of the same suite and is, by its own merits, an excellent product.</p>
<p class="mt-3">But now we introduced the friction to handle two datasets in our app. It is essential to encapsulate the approach to read and write user data in that scenario, so the rest of the app can be blind to this complexity and only see a user with lots of information available to read and simple to extend. Let's do it.</p>
<h2 class="text-xl font-semibold capitalize mt-4">Storing Fireauth Fresh User Information</h2>
<p class="mt-3">Picture ourselves working on an <em class="text-xs bg-gray-200 font-mono py-1 px-2 rounded-sm not-italic">auth.js</em> module inside a bigger web app. In that module, we need to export an interface to the rest of the app, so it can access the user information we fuse between Fireauth and Firestore.</p>
<p class="mt-3">We could start by exporting a simple object that will work as a data store.</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// auth.js</span><br><span class="token keyword">const</span> authState <span class="token operator">=</span> <span class="token punctuation">{</span><br>  userData<span class="token operator">:</span> <span class="token keyword">null</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token keyword">export</span> <span class="token punctuation">{</span> authState <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p class="mt-3">Then, we import the Fireauth object initialized somewhere else in the app and update <em class="text-xs bg-gray-200 font-mono py-1 px-2 rounded-sm not-italic">authState</em> still with only Fireauth data. That is done by passing an observer function to the <em class="text-xs bg-gray-200 font-mono py-1 px-2 rounded-sm not-italic">onAuthStateChanged</em> method of the imported <em class="text-xs bg-gray-200 font-mono py-1 px-2 rounded-sm not-italic">fireauth</em> object. Check the code below.</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> fireauth <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./init-firebase.js'</span><br><br><span class="token keyword">const</span> authState <span class="token operator">=</span> <span class="token punctuation">{</span><br>  userData<span class="token operator">:</span> <span class="token keyword">null</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>fireauth<span class="token punctuation">.</span><span class="token function">onAuthStateChanged</span><span class="token punctuation">(</span><span class="token parameter">user</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  authState<span class="token punctuation">.</span>userData <span class="token operator">=</span> user<br>    <span class="token operator">?</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> user<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> email<span class="token operator">:</span> user<span class="token punctuation">.</span>email <span class="token punctuation">}</span><br>    <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// user has signed out</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">export</span> <span class="token punctuation">{</span> authState <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p class="mt-3">Anyone who imports <em class="text-xs bg-gray-200 font-mono py-1 px-2 rounded-sm not-italic">authState</em> will receive the most updated data at the moment the import statement is interpreted. Which is very uncool üò≥.</p>
<h2 class="text-xl font-semibold capitalize mt-4">Notifying State Change</h2>
<p class="mt-3">Most auth dependent features need to be signaled when auth state changes. A routing system will react to a user signing in by showing the home page with a logout button labeled using the user email.</p>
<p class="mt-3">We can leverage event libraries to help us with that. <a href="https://rxjs-dev.firebaseapp.com/" class="font-semibold text-gray-700 hover:text-green-400">Rxjs</a> is the gold standard, make sure you check on that. To make things simpler, let's use a <a href="https://github.com/joaomelo/bus" class="font-semibold text-gray-700 hover:text-green-400">small library</a> I wrote. It exports two generics <em class="text-xs bg-gray-200 font-mono py-1 px-2 rounded-sm not-italic">subscribe</em> and <em class="text-xs bg-gray-200 font-mono py-1 px-2 rounded-sm not-italic">publish</em> functions.</p>
<p class="mt-3">The <em class="text-xs bg-gray-200 font-mono py-1 px-2 rounded-sm not-italic">subscribe</em> function allows registering observer functions associated with an event name. Every time the <em class="text-xs bg-gray-200 font-mono py-1 px-2 rounded-sm not-italic">publish</em> function is called with that event name, all associated observer functions will be called with the passed payload as an argument.</p>
<p class="mt-3">The code below improves our auth module, raising the ability to subscribe to auth state changes and always receive the latest user data.</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// auth.js</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span> publish <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@joaomelo/bus'</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span> fireauth <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./init-firebase.js'</span><br><br><span class="token keyword">const</span> authState <span class="token operator">=</span> <span class="token punctuation">{</span><br>  userData<span class="token operator">:</span> <span class="token keyword">null</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>fireauth<span class="token punctuation">.</span><span class="token function">onAuthStateChanged</span><span class="token punctuation">(</span><span class="token parameter">user</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  authState<span class="token punctuation">.</span>userData <span class="token operator">=</span> user<br>    <span class="token operator">?</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> user<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> email<span class="token operator">:</span> user<span class="token punctuation">.</span>email <span class="token punctuation">}</span><br>    <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span><br>      <br>  <span class="token comment">// the spread operator avoids direct reference</span><br>  <span class="token comment">// to the state object</span><br>  <span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">'AUTH_STATE_CHANGED'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token operator">...</span>authState <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">export</span> <span class="token punctuation">{</span> authState <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token comment">// some-place-else.js</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span> subscribe <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@joaomelo/bus'</span><br><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">'AUTH_STATE_CHANGED'</span><span class="token punctuation">,</span> <br>  <span class="token parameter">authState</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>authState<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p class="mt-3">That's better üëå, now we can work on the lacking Firestore integration.</p>
<h2 class="text-xl font-semibold capitalize mt-4">Reading Firestore Data</h2>
<p class="mt-3">In Firestore, we will have a <code>profiles</code> collection with a document for every user. The user id will be the tie between a user in Fireauth and the collection's record. For our great happiness üôè, Firestore offers a function to observe data changes directly from this profile document. The following code implements that approach.</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// auth.js</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span> publish <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@joaomelo/bus'</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span> fireauth<span class="token punctuation">,</span> firestore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./init-firebase.js'</span><br><br><span class="token keyword">const</span> authState <span class="token operator">=</span> <span class="token punctuation">{</span><br>  userData<span class="token operator">:</span> <span class="token keyword">null</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>fireauth<span class="token punctuation">.</span><span class="token function">onAuthStateChanged</span><span class="token punctuation">(</span><span class="token parameter">user</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    authState<span class="token punctuation">.</span>userData <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><br>    <span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">'AUTH_STATE_CHANGED'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token operator">...</span>authState <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token comment">// we must be carefull</span><br>  <span class="token comment">// maybe this doc does not exists yet</span><br>  <span class="token keyword">const</span> docRef <span class="token operator">=</span> firestore<br>    <span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'profiles'</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  docRef<br>    <span class="token comment">// 'set' secures doc creation without </span><br>    <span class="token comment">// affecting any preexisting data</span><br>    <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> merge<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <br>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span> <br>      docRef<span class="token punctuation">.</span><span class="token function">onSnapshot</span><span class="token punctuation">(</span><span class="token parameter">doc</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>        <span class="token comment">// the first data load</span><br>        <span class="token comment">// and subsequent updates</span><br>        <span class="token comment">// will trigger this</span><br>        authState<span class="token punctuation">.</span>userData <span class="token operator">=</span> <span class="token punctuation">{</span><br>          id<span class="token operator">:</span> user<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> <br>          email<span class="token operator">:</span> user<span class="token punctuation">.</span>email<span class="token punctuation">,</span><br>          <span class="token operator">...</span>doc<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><span class="token punctuation">;</span><br>        <span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">'AUTH_STATE_CHANGED'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token operator">...</span>authState <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">export</span> <span class="token punctuation">{</span> authState <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p class="mt-3">That's fancy üíÉ stuff. But what if we need to update that user profile?</p>
<h2 class="text-xl font-semibold capitalize mt-4">Updating User Data</h2>
<p class="mt-3">To update user data stored in Firestore, we could create and export a <em class="text-xs bg-gray-200 font-mono py-1 px-2 rounded-sm not-italic">updateUserData</em> function that receives the properties values inside a <em class="text-xs bg-gray-200 font-mono py-1 px-2 rounded-sm not-italic">props</em> parameter. See.</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// auth.js</span><br><br><span class="token comment">// ... all the code until now</span><br><br><span class="token keyword">function</span> <span class="token function">updateUserData</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> docRef <span class="token operator">=</span> firestore<br>    <span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'profiles'</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span>authState<span class="token punctuation">.</span>userData<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// set will return a promise that resolves after</span><br>  <span class="token comment">// the update is complete</span><br>  <span class="token keyword">return</span> docRef<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> <span class="token punctuation">{</span> merge<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">export</span> <span class="token punctuation">{</span> authState<span class="token punctuation">,</span> updateUserData <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p class="mt-3">So simple, I love it ü•∞.</p>
<p class="mt-3">Now we have a module the whole app can use to listen to auth state changes and also freely update user profile information.</p>
<h2 class="text-xl font-semibold capitalize mt-4">Wrapping Up</h2>
<p class="mt-3">Some things were left out. You must have already realized that we did not check any data. That would be very dangerous in a production app. Also, know that Firestore needs properly <a href="https://firebase.google.com/docs/firestore/security/get-started" class="font-semibold text-gray-700 hover:text-green-400">Security Rules</a> to funnel down who and how data could be read and updated.</p>
<p class="mt-3">We could also create a status property in <em class="text-xs bg-gray-200 font-mono py-1 px-2 rounded-sm not-italic">authState</em> to better signal what event happened.</p>
<p class="mt-3">If you are interested, I created a library that deals with that merging between Fireauth and Firestore data and other goodies. It is open-sourced in this GitHub <a href="https://github.com/joaomelo/auth-mech/blob/master/lib/src/auth-mech.js" class="font-semibold text-gray-700 hover:text-green-400">repository</a> and available as a npm <a href="https://www.npmjs.com/package/@joaomelo/auth-mech" class="font-semibold text-gray-700 hover:text-green-400">package</a>.</p>
<p class="mt-3">Goodbye, and stay healthy üò∑.</p>

  </div>
</article>
  </main>
  <footer>
    <section class="mt-8 flex flex-wrap justify-center">
      
        
  <a href="/tags/API/" class="font-semibold text-gray-700 rounded-full bg-green-200 hover:bg-green-400 px-2 mx-1 my-1">API</a>
      
        
  <a href="/tags/airtable/" class="font-semibold text-gray-700 rounded-full bg-green-200 hover:bg-green-400 px-2 mx-1 my-1">airtable</a>
      
        
  <a href="/tags/auth/" class="font-semibold text-gray-700 rounded-full bg-green-200 hover:bg-green-400 px-2 mx-1 my-1">auth</a>
      
        
  <a href="/tags/firebase/" class="font-semibold text-gray-700 rounded-full bg-green-200 hover:bg-green-400 px-2 mx-1 my-1">firebase</a>
      
        
  <a href="/tags/google apps script/" class="font-semibold text-gray-700 rounded-full bg-green-200 hover:bg-green-400 px-2 mx-1 my-1">google apps script</a>
      
    </section>
    <p class="mt-8 mx-8 p-4 text-justify font-mono border-dashed border-4 border-gray-700">Hi! My name is Jo√£o Melo. I am an enthusiast of how leadership and technology combine to create amazing things together ü§ì. I decided to blog about it as I learn what I can. You can get updates from <a href="https://twitter.com/joaomeloplus" target="_blank" class="font-semibold text-gray-700 rounded-full hover:text-green-400">Twitter</a>, and also find me on <a href="https://github.com/joaomelo" target="_blank" class="font-semibold text-gray-700 rounded-full hover:text-green-400">GitHub</a> or <a href="https://www.linkedin.com/in/joaomelo81/?locale=en_US" target="_blank" class="font-semibold text-gray-700 rounded-full hover:text-green-400">LinkedIn</a></p>
    <p class="text-center mt-8 text-xs">content here is copylefted under <a href="https://choosealicense.com/licenses/cc-by-sa-4.0/" target="_blank" class="font-semibold text-gray-700 rounded-full hover:text-green-400">CC-BY-SA-4.0</a></p>
    <br/>
  </footer>
</div>

  </body>
</html>