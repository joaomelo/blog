<!DOCTYPE html>
<html lang="en">
  <head>
    
      <!-- Google Analytics -->
      <script async src="https://www.googletagmanager.com/gtag/js?id=UA-128497960-2"></script>
      <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-128497960-2');
      </script>
      

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    
      <meta name="twitter:card" content="summary_large_image">
    
      <meta name="twitter:title" content="Continuous Delivery To NPM With GitHub Actions">
    

    <link rel="icon" type="image/png" href="/media/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP&family=Roboto:wght@400;900&display=swap" rel="stylesheet">
    <link href="/styles/index.css" rel="stylesheet">

    <title>blog.melo.plus</title>
  </head>
  <body>
    

    <header>
      <h1>
        <a href="/" target="_self">melo.plus</a> 
          
      </h1>
    </header>

    <div class="container">
      <main>
        

<div>
  
  <h1 class="page-title">Continuous Delivery To NPM With GitHub Actions</h1>

  <p class="post-date"><time datetime="2020-07-07T03:00:00.000Z">July 7, 2020</time></p>
  <p></p>
  <article class="post-content">
    <p class="post-paragraph">Open-source libraries and frameworks help us reduce complexity for building apps, bring down bugs, and spread knowledge. In the case of JavaScript packages, <a href="https://www.npmjs.com/">NPM</a> is their standard destiny.</p>
<p class="post-paragraph">Continuous integration and continuous delivery techniques and tools can significantly improve the development lifecycle of those packages reducing the chance of manual missteps and enforcing best practices, like mandatory testing before releases.</p>
<p class="post-paragraph"><a href="https://github.com/features/actions">Actions</a> is GitHub take of this kind of service. It has many appeals, like a generous free tier and, if you are already saving your code there, it is very convenient to put things together.</p>
<p class="post-paragraph">In the next sections, we will explore an approach to publish packages to NPM using GitHub Actions automatically. Here we go üë®‚Äçüîß.</p>
<h2 class="post-subtitle">Local NPM Setup</h2>
<p class="post-paragraph">We will focus on how to set up GitHub, so I will assume you already have some build process to achieve the final code bundle.</p>
<p class="post-paragraph">The first step is to attach this process to an NPM script named <code>prepare</code> inside the <code>package.json</code> file. The name is relevant because anything there will be invoked before every publish.</p>
<p class="post-paragraph">If you need any help with the build setup for NPM packages, you can check this <a href="https://github.com/joaomelo/libt">template repository</a> I authored. In the README, there are links to many resources, and the template itself is a dummy but fully working package.</p>
<p class="post-paragraph">I will also mention a <code>test</code> script during the post, but that is optional. Considering it anyway, the script section in <code>package.json</code> would look something like this:</p>
<pre class="language-json"><code class="language-json"><span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>  <span class="token property">"test"</span><span class="token operator">:</span> <span class="token string">"jest"</span><span class="token punctuation">,</span><br>  <span class="token property">"prepare"</span><span class="token operator">:</span> <span class="token string">"webpack --config webpack.config.js"</span><br><span class="token punctuation">}</span><span class="token punctuation">,</span></code></pre>
<p class="post-paragraph">Now that the NPM scripts are ready, we play with GitHub.</p>
<h2 class="post-subtitle">GitHub Preliminaries</h2>
<p class="post-paragraph">We start authorizing GitHub to publish on our behalf. Go to your profile section at the NPM site, then create and copy an auth token. In the GitHub repository, access the secrets section inside settings and create an <strong>NPM_SECRET</strong> record with the auth token content.</p>
<p class="post-paragraph">It is time to create the workflow file that will run our continuous delivery. There is a wizard interface for that in the <strong>actions</strong> tab in the GitHub repository. If you choose this route, select the first template option, renamed it to <code>publish.yml</code>, and clear all content.</p>
<p class="post-paragraph">We can also generate and edit the file in the local development environment. First, create a <code>.github</code> folder in the project root and, inside it, a <code>workflows</code> subfolder. Lastly, make a <code>publish.yml</code> file inside <code>workflows</code>.</p>
<p class="post-paragraph">Either way, we now start editing <code>publish.yml</code>.</p>
<h2 class="post-subtitle">Writing Jobs Inside The Workflow</h2>
<p class="post-paragraph">In the first part of the workflow, tell GitHub when to trigger the jobs we will write later in the file. One can choose and combine many <a href="https://docs.github.com/en/actions/reference/events-that-trigger-workflows">events</a>, like pull requests, releases, or tags. In the code below, the workflow starts at every push to the main branch.</p>
<pre class="language-yml"><code class="language-yml"><span class="token key atrule">name</span><span class="token punctuation">:</span> publish<br><br><span class="token key atrule">on</span><span class="token punctuation">:</span><br>  <span class="token key atrule">push</span><span class="token punctuation">:</span><br>    <span class="token key atrule">branches</span><span class="token punctuation">:</span><br>      <span class="token punctuation">-</span> <span class="token string">"main"</span></code></pre>
<p class="post-paragraph">Then we begin to unfold all the jobs. The first two kick off in parallel, one to change the package version and another to test the code. Let's inspect the version bumping.</p>
<pre class="language-yml"><code class="language-yml"><span class="token key atrule">jobs</span><span class="token punctuation">:</span><br>  <span class="token key atrule">bump</span><span class="token punctuation">:</span><br>    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest<br>    <span class="token key atrule">steps</span><span class="token punctuation">:</span><br>      <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> <span class="token string">"actions/checkout@v2"</span><br>        <span class="token key atrule">with</span><span class="token punctuation">:</span><br>          <span class="token key atrule">ref</span><span class="token punctuation">:</span> $<br>      <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> <span class="token string">"actions/setup-node@v1"</span><br>        <span class="token key atrule">with</span><span class="token punctuation">:</span><br>          <span class="token key atrule">node-version</span><span class="token punctuation">:</span> <span class="token number">12</span><br>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"version bump"</span><br>        <span class="token key atrule">uses</span><span class="token punctuation">:</span> <span class="token string">"phips28/gh-action-bump-version@main"</span><br>        <span class="token key atrule">with</span><span class="token punctuation">:</span><br>          <span class="token key atrule">tag-prefix</span><span class="token punctuation">:</span> <span class="token string">''</span><br>        <span class="token key atrule">env</span><span class="token punctuation">:</span><br>          <span class="token key atrule">GITHUB_TOKEN</span><span class="token punctuation">:</span> $</code></pre>
<p class="post-paragraph">Here we reused someone else action by calling <code>phips28/gh-action-bump-version@main</code>. That script will choose the version part to increase based on the last commit text. If it finds 'major' or 'minor' string in the commit, the respective section will rise. Mostly any other message will affect the patch section. Please make sure to probe all the <a href="https://github.com/phips28/gh-action-bump-version">provided cases</a>.</p>
<p class="post-paragraph">The test job will follow. If it fails, nothing will be published.</p>
<pre class="language-yml"><code class="language-yml">  <span class="token key atrule">test</span><span class="token punctuation">:</span><br>    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest<br>    <span class="token key atrule">steps</span><span class="token punctuation">:</span><br>      <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2<br>      <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/setup<span class="token punctuation">-</span>node@v1<br>        <span class="token key atrule">with</span><span class="token punctuation">:</span><br>          <span class="token key atrule">node-version</span><span class="token punctuation">:</span> <span class="token number">12</span><br>      <span class="token punctuation">-</span> <span class="token key atrule">run</span><span class="token punctuation">:</span> npm ci<br>      <span class="token punctuation">-</span> <span class="token key atrule">run</span><span class="token punctuation">:</span> npm test</code></pre>
<p class="post-paragraph">If you don't automatically test, ignore the previous job, and make sure to remove its reference in the <code>needs</code> instruction bellow. That instruction tells GitHub Actions to wait for everything in it to finish successfully before continuing.</p>
<pre class="language-yml"><code class="language-yml">  <span class="token key atrule">publish</span><span class="token punctuation">:</span><br>    <span class="token key atrule">needs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>bump<span class="token punctuation">,</span> test<span class="token punctuation">]</span><br>    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest<br>    <span class="token key atrule">steps</span><span class="token punctuation">:</span><br>      <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2<br>        <span class="token key atrule">with</span><span class="token punctuation">:</span><br>          <span class="token key atrule">ref</span><span class="token punctuation">:</span> main<br>      <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/setup<span class="token punctuation">-</span>node@v1<br>        <span class="token key atrule">with</span><span class="token punctuation">:</span><br>          <span class="token key atrule">node-version</span><span class="token punctuation">:</span> <span class="token number">12</span><br>          <span class="token key atrule">registry-url</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//registry.npmjs.org/<br>      <span class="token punctuation">-</span> <span class="token key atrule">run</span><span class="token punctuation">:</span> npm ci<br>      <span class="token punctuation">-</span> <span class="token key atrule">run</span><span class="token punctuation">:</span> npm publish <span class="token punctuation">-</span><span class="token punctuation">-</span>access public<br>        <span class="token key atrule">env</span><span class="token punctuation">:</span><br>          <span class="token key atrule">NODE_AUTH_TOKEN</span><span class="token punctuation">:</span> $</code></pre>
<p class="post-paragraph">Notice that the publishing step executes with the <code>access</code> argument set to <code>public</code>. That is mandatory if the package is <a href="https://docs.npmjs.com/using-npm/scope.html">scoped</a> and will still work fine with non scoped if they are also public.</p>
<p class="post-paragraph">The full script is available below.</p>
<pre class="language-yml"><code class="language-yml"><span class="token key atrule">name</span><span class="token punctuation">:</span> publish<br><br><span class="token key atrule">on</span><span class="token punctuation">:</span><br>  <span class="token key atrule">push</span><span class="token punctuation">:</span><br>    <span class="token key atrule">branches</span><span class="token punctuation">:</span><br>      <span class="token punctuation">-</span> <span class="token string">"main"</span><br><br><span class="token key atrule">jobs</span><span class="token punctuation">:</span><br>  <span class="token key atrule">bump</span><span class="token punctuation">:</span><br>    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest<br>    <span class="token key atrule">steps</span><span class="token punctuation">:</span><br>      <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> <span class="token string">"actions/checkout@v2"</span><br>        <span class="token key atrule">with</span><span class="token punctuation">:</span><br>          <span class="token key atrule">ref</span><span class="token punctuation">:</span> $<br>      <span class="token punctuation">-</span> <span class="token key atrule">run</span><span class="token punctuation">:</span> sed <span class="token punctuation">-</span>n 3p ./package.json<br>      <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> <span class="token string">"actions/setup-node@v1"</span><br>        <span class="token key atrule">with</span><span class="token punctuation">:</span><br>          <span class="token key atrule">node-version</span><span class="token punctuation">:</span> <span class="token number">12</span><br>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"version bump"</span><br>        <span class="token key atrule">uses</span><span class="token punctuation">:</span> <span class="token string">"phips28/gh-action-bump-version@main"</span><br>        <span class="token key atrule">with</span><span class="token punctuation">:</span><br>          <span class="token key atrule">tag-prefix</span><span class="token punctuation">:</span> <span class="token string">''</span><br>        <span class="token key atrule">env</span><span class="token punctuation">:</span><br>          <span class="token key atrule">GITHUB_TOKEN</span><span class="token punctuation">:</span> $<br>      <span class="token punctuation">-</span> <span class="token key atrule">run</span><span class="token punctuation">:</span> sed <span class="token punctuation">-</span>n 3p ./package.json<br><br>  <span class="token key atrule">test</span><span class="token punctuation">:</span><br>    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest<br>    <span class="token key atrule">steps</span><span class="token punctuation">:</span><br>      <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2<br>      <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/setup<span class="token punctuation">-</span>node@v1<br>        <span class="token key atrule">with</span><span class="token punctuation">:</span><br>          <span class="token key atrule">node-version</span><span class="token punctuation">:</span> <span class="token number">12</span><br>      <span class="token punctuation">-</span> <span class="token key atrule">run</span><span class="token punctuation">:</span> npm ci<br>      <span class="token punctuation">-</span> <span class="token key atrule">run</span><span class="token punctuation">:</span> npm test<br><br>  <span class="token key atrule">publish</span><span class="token punctuation">:</span><br>    <span class="token key atrule">needs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>bump<span class="token punctuation">,</span> test<span class="token punctuation">]</span><br>    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest<br>    <span class="token key atrule">steps</span><span class="token punctuation">:</span><br>      <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2<br>        <span class="token key atrule">with</span><span class="token punctuation">:</span><br>          <span class="token key atrule">ref</span><span class="token punctuation">:</span> main<br>      <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/setup<span class="token punctuation">-</span>node@v1<br>        <span class="token key atrule">with</span><span class="token punctuation">:</span><br>          <span class="token key atrule">node-version</span><span class="token punctuation">:</span> <span class="token number">12</span><br>          <span class="token key atrule">registry-url</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//registry.npmjs.org/<br>      <span class="token punctuation">-</span> <span class="token key atrule">run</span><span class="token punctuation">:</span> npm ci<br>      <span class="token punctuation">-</span> <span class="token key atrule">run</span><span class="token punctuation">:</span> npm publish <span class="token punctuation">-</span><span class="token punctuation">-</span>access public<br>        <span class="token key atrule">env</span><span class="token punctuation">:</span><br>          <span class="token key atrule">NODE_AUTH_TOKEN</span><span class="token punctuation">:</span> $</code></pre>
<p class="post-paragraph">That's it, folks. GitHub Action is a fast-evolving ecosystem and will continue to give birth to many more useful tools. I hope the content helped üòÄ.</p>

  </article>
</div>
      </main>
      <footer>
        <div class="tags">
          
            
  <a href="/tags/airtable/" class="content-tag">airtable</a>
          
            
  <a href="/tags/api/" class="content-tag">api</a>
          
            
  <a href="/tags/auth/" class="content-tag">auth</a>
          
            
  <a href="/tags/devops/" class="content-tag">devops</a>
          
            
  <a href="/tags/education/" class="content-tag">education</a>
          
            
  <a href="/tags/firebase/" class="content-tag">firebase</a>
          
            
  <a href="/tags/github/" class="content-tag">github</a>
          
            
  <a href="/tags/google apps script/" class="content-tag">google apps script</a>
          
            
  <a href="/tags/patterns/" class="content-tag">patterns</a>
          
            
  <a href="/tags/reactivity/" class="content-tag">reactivity</a>
          
        </div>
        <p class="about">Hi! My name is Jo√£o Melo. I am enthusiastic about how determination and technology combine to create amazing things ü§ì. I decided to blog about it as I learn what I can. You can get updates from <a href="https://twitter.com/joaomeloplus" target="_blank">Twitter</a>, and also find me on <a href="https://github.com/joaomelo" target="_blank">GitHub</a> or <a href="https://www.linkedin.com/in/joaomelo81/?locale=en_US" target="_blank">LinkedIn</a></p>          
        <p class="license">content here is copylefted under <a href="https://choosealicense.com/licenses/cc-by-sa-4.0/" target="_blank">CC-BY-SA-4.0</a></p>
      </footer>
    </div>
  </body>
</html>
