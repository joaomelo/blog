<!DOCTYPE html>
<html lang="en">
  <head>
      

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    
      <meta name="twitter:card" content="summary_large_image">
    
      <meta name="twitter:title" content="How To Combine Firebase Authentication And Firestore To Save User Data">
    
      <meta name="twitter:image" content="https://blog.melo.plus\media\2020-06-07-how-to-combine-firebase-authentication-and-firestore-to-save-user-data-cover.png">
    

    <link rel="icon" type="image/png" href="/media/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP&family=Roboto:wght@400;900&display=swap" rel="stylesheet">
    <link href="/styles/index.css" rel="stylesheet">

    <title>blog.melo.plus</title>
  </head>
  <body>
    

    <header>
      <h1>
        <a href="/" target="_self">melo.plus</a> 
        
          <span style="font-size: small;">dev</span>
          
      </h1>
    </header>

    <div class="container">
      <main>
        

<div>
  
  <h1 class="page-title">How To Combine Firebase Authentication And Firestore To Save User Data</h1>

  <p class="post-date"><time datetime="2020-06-07T03:00:00.000Z">June 7, 2020</time></p>
  <p></p>
  <article class="post-content">
    <p class="post-paragraph"><a href="https://firebase.google.com/">Firebase</a> is a boost of agility to solo developers and small teams. One of its main conveniences is the authentication service. But after a few times building login UI with Firebase Authentication (Fireauth), I found myself repeating code to wrap or complement its features. One of such cases is the need to combine user data from Fireauth with another database.</p>
<p class="post-paragraph">Fireauth can hold some profile user data, but they are limited to a <a href="https://firebase.google.com/docs/auth/users#user%60properties">&quot;fixed set of basic properties&quot;</a>. If you want more, you need a database solution. Firestore is part of the same suite and is, by its own merits, an excellent product.</p>
<p class="post-paragraph">But now we introduced the friction to handle two datasets in our app. It is essential to encapsulate the approach to read and write user data in that scenario, so the rest of the app can be blind to this complexity and only see a user with lots of information available to read and simple to extend. Let's do it.</p>
<h2 class="post-subtitle">Storing Fireauth Fresh User Information</h2>
<p class="post-paragraph">Picture ourselves working on an <code>auth.js</code> module inside a bigger web app. In that module, we need to export an interface to the rest of the app, so it can access the user information we fuse between Fireauth and Firestore.</p>
<p class="post-paragraph">We could start by exporting a simple object that will work as a data store.</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// auth.js</span><br><span class="token keyword">const</span> authState <span class="token operator">=</span> <span class="token punctuation">{</span><br>  userData<span class="token operator">:</span> <span class="token keyword">null</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token keyword">export</span> <span class="token punctuation">{</span> authState <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p class="post-paragraph">Then, we import the Fireauth object initialized somewhere else in the app and update <code>authState</code> still with only Fireauth data. That is done by passing an observer function to the <code>onAuthStateChanged</code> method of the imported <code>fireauth</code> object. Check the code below.</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> fireauth <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./init-firebase.js'</span><br><br><span class="token keyword">const</span> authState <span class="token operator">=</span> <span class="token punctuation">{</span><br>  userData<span class="token operator">:</span> <span class="token keyword">null</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>fireauth<span class="token punctuation">.</span><span class="token function">onAuthStateChanged</span><span class="token punctuation">(</span><span class="token parameter">user</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  authState<span class="token punctuation">.</span>userData <span class="token operator">=</span> user<br>    <span class="token operator">?</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> user<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> email<span class="token operator">:</span> user<span class="token punctuation">.</span>email <span class="token punctuation">}</span><br>    <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// user has signed out</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">export</span> <span class="token punctuation">{</span> authState <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p class="post-paragraph">Anyone who imports <code>authState</code> will receive the most updated data at the moment the import statement is interpreted. Which is very uncool üò≥.</p>
<h2 class="post-subtitle">Notifying State Change</h2>
<p class="post-paragraph">Most auth dependent features need to be signaled when auth state changes. A routing system will react to a user signing in by showing the home page with a logout button labeled using the user email.</p>
<p class="post-paragraph">We can leverage event libraries to help us with that. <a href="https://rxjs-dev.firebaseapp.com/">Rxjs</a> is the gold standard, make sure you check on that. To make things simpler, let's use a <a href="https://github.com/joaomelo/bus">small library</a> I wrote. It exports two generics <code>subscribe</code> and <code>publish</code> functions.</p>
<p class="post-paragraph">The <code>subscribe</code> function allows registering observer functions associated with an event name. Every time the <code>publish</code> function is called with that event name, all associated observer functions will be called with the passed payload as an argument.</p>
<p class="post-paragraph">The code below improves our auth module, raising the ability to subscribe to auth state changes and always receive the latest user data.</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// auth.js</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span> publish <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@joaomelo/bus'</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span> fireauth <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./init-firebase.js'</span><br><br><span class="token keyword">const</span> authState <span class="token operator">=</span> <span class="token punctuation">{</span><br>  userData<span class="token operator">:</span> <span class="token keyword">null</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>fireauth<span class="token punctuation">.</span><span class="token function">onAuthStateChanged</span><span class="token punctuation">(</span><span class="token parameter">user</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  authState<span class="token punctuation">.</span>userData <span class="token operator">=</span> user<br>    <span class="token operator">?</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> user<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> email<span class="token operator">:</span> user<span class="token punctuation">.</span>email <span class="token punctuation">}</span><br>    <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span><br>      <br>  <span class="token comment">// the spread operator avoids direct reference</span><br>  <span class="token comment">// to the state object</span><br>  <span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">'AUTH`STATE`CHANGED'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token operator">...</span>authState <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">export</span> <span class="token punctuation">{</span> authState <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token comment">// some-place-else.js</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span> subscribe <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@joaomelo/bus'</span><br><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">'AUTH`STATE`CHANGED'</span><span class="token punctuation">,</span> <br>  <span class="token parameter">authState</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>authState<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p class="post-paragraph">That's better üëå, now we can work on the lacking Firestore integration.</p>
<h2 class="post-subtitle">Reading Firestore Data</h2>
<p class="post-paragraph">In Firestore, we will have a <code>profiles</code> collection with a document for every user. The user id will be the tie between a user in Fireauth and the collection's record. For our great happiness üôè, Firestore offers a function to observe data changes directly from this profile document. The following code implements that approach.</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// auth.js</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span> publish <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@joaomelo/bus'</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span> fireauth<span class="token punctuation">,</span> firestore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./init-firebase.js'</span><br><br><span class="token keyword">const</span> authState <span class="token operator">=</span> <span class="token punctuation">{</span><br>  userData<span class="token operator">:</span> <span class="token keyword">null</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>fireauth<span class="token punctuation">.</span><span class="token function">onAuthStateChanged</span><span class="token punctuation">(</span><span class="token parameter">user</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    authState<span class="token punctuation">.</span>userData <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><br>    <span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">'AUTH`STATE`CHANGED'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token operator">...</span>authState <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token comment">// we must be carefull</span><br>  <span class="token comment">// maybe this doc does not exists yet</span><br>  <span class="token keyword">const</span> docRef <span class="token operator">=</span> firestore<br>    <span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'profiles'</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  docRef<br>    <span class="token comment">// 'set' secures doc creation without </span><br>    <span class="token comment">// affecting any preexisting data</span><br>    <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> merge<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <br>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span> <br>      docRef<span class="token punctuation">.</span><span class="token function">onSnapshot</span><span class="token punctuation">(</span><span class="token parameter">doc</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>        <span class="token comment">// the first data load</span><br>        <span class="token comment">// and subsequent updates</span><br>        <span class="token comment">// will trigger this</span><br>        authState<span class="token punctuation">.</span>userData <span class="token operator">=</span> <span class="token punctuation">{</span><br>          id<span class="token operator">:</span> user<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> <br>          email<span class="token operator">:</span> user<span class="token punctuation">.</span>email<span class="token punctuation">,</span><br>          <span class="token operator">...</span>doc<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>        <span class="token punctuation">}</span><span class="token punctuation">;</span><br>        <span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">'AUTH`STATE`CHANGED'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token operator">...</span>authState <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">export</span> <span class="token punctuation">{</span> authState <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p class="post-paragraph">That's fancy üíÉ stuff. But what if we need to update that user profile?</p>
<h2 class="post-subtitle">Updating User Data</h2>
<p class="post-paragraph">To update user data stored in Firestore, we could create and export a <code>updateUserData</code> function that receives the properties values inside a <code>props</code> parameter. See.</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// auth.js</span><br><br><span class="token comment">// ... all the code until now</span><br><br><span class="token keyword">function</span> <span class="token function">updateUserData</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> docRef <span class="token operator">=</span> firestore<br>    <span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'profiles'</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span>authState<span class="token punctuation">.</span>userData<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// set will return a promise that resolves after</span><br>  <span class="token comment">// the update is complete</span><br>  <span class="token keyword">return</span> docRef<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> <span class="token punctuation">{</span> merge<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">export</span> <span class="token punctuation">{</span> authState<span class="token punctuation">,</span> updateUserData <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p class="post-paragraph">So simple, I love it ü•∞.</p>
<p class="post-paragraph">Now we have a module the whole app can use to listen to auth state changes and also freely update user profile information.</p>
<h2 class="post-subtitle">Wrapping Up</h2>
<p class="post-paragraph">Some things were left out. You must have already realized that we did not check any data. That would be very dangerous in a production app. Also, know that Firestore needs properly <a href="https://firebase.google.com/docs/firestore/security/get-started">Security Rules</a> to funnel down who and how data could be read and updated.</p>
<p class="post-paragraph">We could also create a status property in <code>authState</code> to better signal what event happened.</p>
<p class="post-paragraph">If you are interested, I created a library that deals with that merging between Fireauth and Firestore data and other goodies. It is open-sourced in this GitHub <a href="https://github.com/joaomelo/auth-mech/blob/master/lib/src/auth-mech.js">repository</a> and available as a npm <a href="https://www.npmjs.com/package/@joaomelo/auth-mech">package</a>.</p>
<p class="post-paragraph">Goodbye, and stay healthy üò∑.</p>

  </article>
</div>
      </main>
      <footer>
        <div class="tags">
          
            
  <a href="/tags/airtable/" class="content-tag">airtable</a>
          
            
  <a href="/tags/api/" class="content-tag">api</a>
          
            
  <a href="/tags/auth/" class="content-tag">auth</a>
          
            
  <a href="/tags/devops/" class="content-tag">devops</a>
          
            
  <a href="/tags/education/" class="content-tag">education</a>
          
            
  <a href="/tags/firebase/" class="content-tag">firebase</a>
          
            
  <a href="/tags/github/" class="content-tag">github</a>
          
            
  <a href="/tags/google apps script/" class="content-tag">google apps script</a>
          
            
  <a href="/tags/patterns/" class="content-tag">patterns</a>
          
            
  <a href="/tags/reactivity/" class="content-tag">reactivity</a>
          
        </div>
        <p class="about">Hi! My name is Jo√£o Melo. I am enthusiastic about how determination and technology combine to create amazing things ü§ì. I decided to blog about it as I learn what I can. You can get updates from <a href="https://twitter.com/joaomeloplus" target="_blank">Twitter</a>, and also find me on <a href="https://github.com/joaomelo" target="_blank">GitHub</a> or <a href="https://www.linkedin.com/in/joaomelo81/?locale=en_US" target="_blank">LinkedIn</a></p>          
        <p class="license">content here is copylefted under <a href="https://choosealicense.com/licenses/cc-by-sa-4.0/" target="_blank">CC-BY-SA-4.0</a></p>
      </footer>
    </div>
  </body>
</html>
