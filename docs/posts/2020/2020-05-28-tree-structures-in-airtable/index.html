<!DOCTYPE html>
<html lang="en">
  <head>
      

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    
      <meta name="twitter:card" content="summary_large_image">
    
      <meta name="twitter:title" content="Tree Structures in Airtable">
    
      <meta name="twitter:image" content="\media\2020-05-28-tree-structures-in-airtable-cover.png">
    

    <link rel="icon" type="image/png" href="/media/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP&family=Roboto:wght@400;900&display=swap" rel="stylesheet">
    <link href="/styles/index.css" rel="stylesheet">

    <title>blog.melo.plus</title>
  </head>
  <body>
    

    <header>
      <h1>
        <a href="/" target="_self">melo.plus</a> 
        
          <span style="font-size: small;">dev</span>
          
      </h1>
    </header>

    <div class="container">
      <main>
        

<div>
  
  <h1 class="page-title">Tree Structures in Airtable</h1>

  <p class="post-date"><time datetime="2020-05-28T03:00:00.000Z">May 28, 2020</time></p>
  <p></p>
  <article class="post-content">
    <p class="post-paragraph"><a href="https://airtable.com/">Airtable</a> is a powerful tool. It has tons of features to edit and visualize data. I use it to organize many of my personal workflows. It is also an amazing prototyping mechanism to test ideas before starting a new app.</p>
<p class="post-paragraph">The inability to create tree structures with table's records is one of my small frustrations with it. As you can see in the next image, although Airtable is perfectly able to link records in the same table, one cannot order them properly without a way to fill a path string for every item.</p>
<p class="post-paragraph"><img src="/media/2020-05-28-tree-unable-in-airtable.gif" alt="unable to create a tree in airtable" class="post-image"></p>
<p class="post-paragraph">The good news is that Airtable offers an API. So, we can set our path field with the power of JavaScript and a couple of libraries. Let me share in this post a way to accomplish that.</p>
<h2 class="post-subtitle">Project Setup</h2>
<p class="post-paragraph">We will use vanilla Html and JavaScript for our project with the help of some packages:</p>
<ul class="post-ul">
<li><a href="https://github.com/airtable/airtable.js/">airtable.js</a> is the official library to consume their API;</li>
<li><a href="https://tailwindcss.com/">tailwind</a> provides utility classes to style our app.</li>
</ul>
<p class="post-paragraph">Since we are already talking about packages, don't worry if you are not familiar with Tailwind. It is a CSS framework with an <a href="https://tailwindcss.com/docs/utility-first/">utility first</a> mentality. You don't need to learn anything about it for our exercise here. Keep calm and carry on aware that a lot of classes will appear in the Html.</p>
<p class="post-paragraph">If you find yourself lost at any point have no worry. You can go to <a href="https://github.com/joaomelo/tree-structures-in-airtable">this</a> repository and download the full app. I versioned it in different folders corresponding to each post milestone.</p>
<p class="post-paragraph">But enough of talking, let's code. We start with a skeleton <code>index.html</code> just pulling the third party packages and our own future script file that will be created in a moment.</p>
<pre class="language-html"><code class="language-html"><span class="token doctype">&lt;!DOCTYPE html></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span><br><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1, shrink-to-fit=no<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://unpkg.com/tailwindcss@^1.0/dist/tailwind.min.css<span class="token punctuation">"</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://unpkg.com/airtable@0.8.1/build/airtable.browser.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>tree-structures-in-airtable<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><br><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>bg-gray-100<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>max-w-screen-sm my-8 mx-auto px-4 bg-white min-h-screen<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text-2xl text-gray-600 font-bold text-center pt-4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>        Tree Structures in Airtable<br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>main</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>app<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text-center<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>main</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>index.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre>
<p class="post-paragraph">Now create an <code>index.js</code> file in the same folder. For now, we write a dummy code just to test if things properly tighten.</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"app"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>el<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">"Hello World!"</span></code></pre>
<p class="post-paragraph">If you open <code>index.html</code> in the local server of your choice, you will see our baby ðŸ‘¶ first step.</p>
<h2 class="post-subtitle">Basic UI</h2>
<p class="post-paragraph">Airtable API needs three basic information: your personal API key, the base id where the given table is located, and the table name. We need to create some inputs to ask that from the user, a button to run our script and a message area to provide feedback. We can update the code inside the <code>main</code> tag of our <code>index.html</code> with the code below.</p>
<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>main</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>app<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mt-4 border-dashed border p-2<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>flex items-center mt-4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>key<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>w-1/4 block text-gray-500 font-bold text-right mb-0 pr-4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>        Api Key<br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>key<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>w-3/4 bg-gray-200 appearance-none border-2 border-gray-200 rounded w-full py-2 px-4 text-gray-700 leading-tight focus:outline-none focus:bg-white focus:border-purple-500<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>flex items-center mt-4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>base<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>w-1/4 block text-gray-500 font-bold text-right mb-0 pr-4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>        Base ID<br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>base<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>w-3/4 bg-gray-200 appearance-none border-2 border-gray-200 rounded w-full py-2 px-4 text-gray-700 leading-tight focus:outline-none focus:bg-white focus:border-purple-500<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>flex items-center mt-4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>table<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>w-1/4 block text-gray-500 font-bold text-right mb-0 pr-4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>        Table Name<br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>table<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>w-3/4 bg-gray-200 appearance-none border-2 border-gray-200 rounded w-full py-2 px-4 text-gray-700 leading-tight focus:outline-none focus:bg-white focus:border-purple-500<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>flex justify-center mt-4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>run<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mt-2 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>        Run<br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>logs<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mt-4 mx-2 py-8 bg-gray-100 text-center text-gray-500 font-mono font-bold<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>click "run" to update records<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>      <br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>main</span><span class="token punctuation">></span></span></code></pre>
<p class="post-paragraph">You can open the app now and cry in frustration since nothing changed ðŸ˜­. That's because <code>index.js</code> is overwriting everything inside <code>main</code>. With a small adjustment in the tag id, we change that.</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> div <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"logs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>div<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">"Hello World!"</span></code></pre>
<p class="post-paragraph">Cool. Now the message is in the logs area and we can move on to pull data directly from Airtable.</p>
<h2 class="post-subtitle">Reading Records from Airtable</h2>
<p class="post-paragraph">Before going to the nitty-gritty of loading records from Airtable, we must install the trigger that starts the whole operation. We do that by assigning a function to our Run button <code>onclick</code> property. The function will grab the user input values and ask Airtable for the corresponding table records. In the following code, we declare some helpers functions and make the run button alive. There is also a silly version of what will be our loader function, so we can test the UI.</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// where everything starts</span><br><span class="token function">byId</span><span class="token punctuation">(</span><span class="token string">'run'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token function">byId</span><span class="token punctuation">(</span><span class="token string">'logs'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span><br>  <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// helper functions</span><br><span class="token keyword">function</span> <span class="token function">byId</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">addLog</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> p <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  p<span class="token punctuation">.</span>innerText <span class="token operator">=</span> text<span class="token punctuation">;</span><br>  <span class="token function">byId</span><span class="token punctuation">(</span><span class="token string">'logs'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// start of business code</span><br><span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token function">addLog</span><span class="token punctuation">(</span><span class="token string">'run forest run'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p class="post-paragraph">The first step to proper load data is to create a <code>Table</code> object using Airtable's library. This object will have the methods needed to update and read from Airtable.</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> apiKey <span class="token operator">=</span> <span class="token function">byId</span><span class="token punctuation">(</span><span class="token string">'key'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span><br>  <span class="token keyword">const</span> baseId <span class="token operator">=</span> <span class="token function">byId</span><span class="token punctuation">(</span><span class="token string">'base'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span><br>  <span class="token keyword">const</span> tableName <span class="token operator">=</span> <span class="token function">byId</span><span class="token punctuation">(</span><span class="token string">'table'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span><br><br>  <span class="token keyword">const</span> Airtable <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'airtable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> table <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Airtable</span><span class="token punctuation">(</span><span class="token punctuation">{</span> apiKey <span class="token punctuation">}</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">base</span><span class="token punctuation">(</span>baseId<span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">table</span><span class="token punctuation">(</span>tableName<span class="token punctuation">)</span><br><br>  <span class="token function">loadRecords</span><span class="token punctuation">(</span>table<span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">records</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>      <span class="token keyword">const</span> n <span class="token operator">=</span> records<span class="token punctuation">.</span>length<span class="token punctuation">;</span><br>      <span class="token function">addLog</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">loaded </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>n<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> record(s) from </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tableName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <br><span class="token punctuation">}</span></code></pre>
<p class="post-paragraph">Inside <code>loadRecords</code>, we use the <code>select</code> method from the <code>Table</code> object to create a <code>query</code> object. The query has an <code>eachPage</code> method that paginates through all records in a table applying a provided callback function and returning a Promise at the end. Let's put that design to action to fill an array with records.</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">loadRecords</span><span class="token punctuation">(</span><span class="token parameter">table</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> allRecords <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> table<br>    <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// creates the query</span><br>    <span class="token punctuation">.</span><span class="token function">eachPage</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">pageRecords<span class="token punctuation">,</span> fetchNextPage</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>      pageRecords<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=></span> allRecords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token function">fetchNextPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// apply callback to all table</span><br>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> allRecords<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p class="post-paragraph">Yeah! The app can load data from Airtable. It should look like the gif below.</p>
<p class="post-paragraph"><img src="/media/2020-05-28-load-records.gif" alt="app now loads records" class="post-image"></p>
<p class="post-paragraph">Don't you love ðŸ¥° coding?! But we should not get ahead of ourselves. We still need to update that damn path field.</p>
<h2 class="post-subtitle">Resolving Paths</h2>
<p class="post-paragraph">The Table object created earlier also exposes an update method that changes provided fields values without trampling with the rest of the record. But to use that we first need to know which records need new path values and first of all, what is the path value of a record? Let's think about it.</p>
<p class="post-paragraph">The easiest case comes from records that don't have a parent. In these cases, we can use the title field as the path. Then if the record indeed has a parent, we append the parent title to the path of our record and go on checking and aggregating titles until we find an ancestor without a parent. Based on that, we can risk a function that calculates the path for a given record.</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">calcPath</span><span class="token punctuation">(</span><span class="token parameter">record<span class="token punctuation">,</span> records</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token function-variable function">findParent</span> <span class="token operator">=</span> <span class="token parameter">child</span> <span class="token operator">=></span> child<span class="token punctuation">.</span>fields<span class="token punctuation">.</span>parent<br>    <span class="token operator">?</span> records<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=></span> r<span class="token punctuation">.</span>id <span class="token operator">===</span> child<span class="token punctuation">.</span>fields<span class="token punctuation">.</span>parent<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><br>    <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">let</span> path <span class="token operator">=</span> record<span class="token punctuation">.</span>fields<span class="token punctuation">.</span>name<span class="token punctuation">;</span><br>  <span class="token keyword">let</span> parent <span class="token operator">=</span> <span class="token function">findParent</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">while</span> <span class="token punctuation">(</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    path <span class="token operator">=</span> parent<span class="token punctuation">.</span>fields<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> path<span class="token punctuation">;</span><br>    parent <span class="token operator">=</span> <span class="token function">findParent</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">return</span> path<span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p class="post-paragraph">With that, calcPath can be called for every record loaded from Airtable. If the calculated path differs from the original value found at the record, we update the table. Time for another function.</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// ... we change a bit of the run function</span><br>  <span class="token function">loadRecords</span><span class="token punctuation">(</span>table<span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">records</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>      <span class="token keyword">const</span> n <span class="token operator">=</span> records<span class="token punctuation">.</span>length<span class="token punctuation">;</span><br>      <span class="token function">addLog</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">loaded </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>n<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> record(s) from </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tableName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">return</span> <span class="token function">updatePaths</span><span class="token punctuation">(</span>table<span class="token punctuation">,</span> records<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">addLog</span><span class="token punctuation">(</span><span class="token string">'paths updated'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// and create updatePaths</span><br><span class="token keyword">function</span> <span class="token function">updatePaths</span><span class="token punctuation">(</span><span class="token parameter">table<span class="token punctuation">,</span> records</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> updatePromises <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>  records<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">record</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> newPath <span class="token operator">=</span> <span class="token function">calcPath</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> records<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>record<span class="token punctuation">.</span>fields<span class="token punctuation">.</span>path <span class="token operator">!==</span> newPath<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">const</span> promise <span class="token operator">=</span> <span class="token function">updateRecord</span><span class="token punctuation">(</span>table<span class="token punctuation">,</span><br>        record<span class="token punctuation">.</span>id<span class="token punctuation">,</span><br>        <span class="token punctuation">{</span> path<span class="token operator">:</span> newPath <span class="token punctuation">}</span><br>      <span class="token punctuation">)</span><span class="token punctuation">;</span><br>      updatePromises<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>updatePromises<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p class="post-paragraph">Even without knowing how to send the new data to Airtable, yet ðŸ˜‰. We could write a minimal version of the <code>updateRecord</code> function just to check if our algorithm is working. Please add the following instructions.</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">updateRecord</span><span class="token punctuation">(</span><span class="token parameter">table<span class="token punctuation">,</span> id<span class="token punctuation">,</span> entries</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token function">addLog</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">update </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> to "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>entries<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<h2 class="post-subtitle">Updating Airtable</h2>
<p class="post-paragraph">That <code>table</code> object we have been talking about has an <code>update</code> method to send changes to Airtable. But we need to take care of their rate limits first.</p>
<p class="post-paragraph">Airtable won't allow more than five calls per second to its API. If at some point the app tries to update many records at once, we will find ourselves been punished with a 30 seconds penalty. That definitely is not cool.</p>
<p class="post-paragraph">There are gracious ways to secure that, especially with packages like <a href="https://rxjs-dev.firebaseapp.com/">rxjs</a> and <a href="https://github.com/SGrondin/bottleneck">bottleneck</a> - make sure to check the second one if you're going seriously into API calls. But we will use a simpler approach by forcing a waiting time before each update call to Airtable using <code>setTimeout</code>.</p>
<p class="post-paragraph">We do that by saving the time of the last API call in a variable outside the function. Then we compare the distance from the present moment to that last call and subtract that distance from a minimal 200 milliseconds interval between calls (1 second divided by the maximum 5 calls per second).</p>
<p class="post-paragraph">We go on creating a Promise that will resolve with the call to the <code>update</code> method, but just when setTimeout is done with the calculated timeout. Finally, we update the <code>last</code> variable with the projected future moment when the timeout concludes. I think the code should make it more clear.</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">let</span> last<span class="token punctuation">;</span><br><span class="token keyword">function</span> <span class="token function">updateRecord</span><span class="token punctuation">(</span><span class="token parameter">table<span class="token punctuation">,</span> id<span class="token punctuation">,</span> entries</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> interval <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> now <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> passed <span class="token operator">=</span> last <span class="token operator">?</span> now <span class="token operator">-</span> last <span class="token operator">:</span> interval<span class="token punctuation">;</span><br>  <span class="token keyword">const</span> timeout <span class="token operator">=</span> interval <span class="token operator">-</span> passed<span class="token punctuation">;</span>  <br>  <br>  <span class="token keyword">const</span> updatePromise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=></span> <br>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><br>      <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">resolve</span><span class="token punctuation">(</span>table<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> entries<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>      timeout<br>    <span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  last <span class="token operator">=</span> now <span class="token operator">+</span> timeout<span class="token punctuation">;</span>  <br>  <span class="token keyword">return</span> updatePromise<span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p class="post-paragraph">I think everything is patched. Test the workflow and check if every record has a shining updated path text field.</p>
<p class="post-paragraph"><img src="/media/2020-05-28-path-updating.gif" alt="update running smoothly" class="post-image"></p>
<h2 class="post-subtitle">Final Thoughts</h2>
<p class="post-paragraph">There is a ton of stuff that could be improved here. I didn't deal with user invalid inputs or catch any exception from API calls for example. I am leaving these next steps for your brave soul.</p>
<p class="post-paragraph">If you are interested, I created for myself a web app to run this kind of path update with more options like configurable field names or the ability to inject a status emoji in the path to better order records. The app also creates recursive tasks. It is open-sourced in this GitHub <a href="https://github.com/joaomelo/mytable">repository</a> and free to use in a very uncommitted way at <a href="https://mytable.melo.plus">mytable.melo.plus</a>.</p>
<p class="post-paragraph">I leave you with my best regards.</p>

  </article>
</div>
      </main>
      <footer>
        <div class="tags">
          
            
  <a href="/tags/API/" class="content-tag">API</a>
          
            
  <a href="/tags/airtable/" class="content-tag">airtable</a>
          
            
  <a href="/tags/auth/" class="content-tag">auth</a>
          
            
  <a href="/tags/firebase/" class="content-tag">firebase</a>
          
            
  <a href="/tags/google apps script/" class="content-tag">google apps script</a>
          
            
  <a href="/tags/patterns/" class="content-tag">patterns</a>
          
            
  <a href="/tags/reactivity/" class="content-tag">reactivity</a>
          
        </div>
        <p class="about">Hi! My name is JoÃ£o Melo. I am enthusiastic about how determination and technology combine to create amazing things ðŸ¤“. I decided to blog about it as I learn what I can. You can get updates from <a href="https://twitter.com/joaomeloplus" target="_blank">Twitter</a>, and also find me on <a href="https://github.com/joaomelo" target="_blank">GitHub</a> or <a href="https://www.linkedin.com/in/joaomelo81/?locale=en_US" target="_blank">LinkedIn</a></p>          
        <p class="license">content here is copylefted under <a href="https://choosealicense.com/licenses/cc-by-sa-4.0/" target="_blank">CC-BY-SA-4.0</a></p>
      </footer>
    </div>
  </body>
</html>
